{% extends "layout.html" %}

{% block content %}
<div class="bento-grid animate-enter">
  <div class="bento-card span-4">
    <div class="card-header">
      <span class="card-title">VPN & Threat Alerts</span>
      <i class="ri-shield-flash-line card-icon" style="color: var(--danger)"></i>
    </div>

    <div id="no-threats-msg" style="padding: 2rem; text-align: center; color: var(--text-muted); display: none;">
      <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--success);">
        <i class="ri-shield-check-line"></i>
      </div>
      <h3>No Active Threats Detected</h3>
      <p>Your network appears to be secure. The ML engine is monitoring for anomalies.</p>
    </div>

    <div id="threats-table-container" style="margin-top: 1rem; display: none;">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Source IP</th>
            <th>Reason</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="alerts-body">
          <!-- Alerts go here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  async function loadAlerts() {
    try {
      const res = await fetch('/api/vpn-alerts');
      const alerts = await res.json();

      const noMsg = document.getElementById('no-threats-msg');
      const table = document.getElementById('threats-table-container');
      const tbody = document.getElementById('alerts-body');

      if (alerts.length === 0) {
        noMsg.style.display = 'block';
        table.style.display = 'none';
      } else {
        noMsg.style.display = 'none';
        table.style.display = 'block';

        tbody.innerHTML = alerts.map(a => `
                <tr>
                    <td class="mono" style="color: var(--text-muted);">${a.time}</td>
                    <td><a href="/user/${a.ip}" class="mono" style="color: var(--primary); text-decoration: none;">${a.ip}</a></td>
                    <td><span class="badge danger">${a.reason}</span></td>
                    <td>
                        <button class="action-btn" onclick="alert('Details: ' + '${a.reason}')">
                            <i class="ri-eye-line"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
      }
    } catch (e) {
      console.error("Failed to load alerts", e);
    }
  }

  document.addEventListener('DOMContentLoaded', loadAlerts);
  // Refresh every 5 seconds
  setInterval(loadAlerts, 5000);
</script>
{% endblock %}