{% extends "layout.html" %} {% block content %}
<div class="bento-grid animate-enter">
  <!-- Server Info -->
  <div class="bento-card span-1">
    <div class="card-header">
      <span class="card-title">Server Status</span>
      <i class="ri-server-line card-icon"></i>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
      <div>
        <div style="font-size: 0.8rem; color: var(--text-muted)">Hostname</div>
        <div class="mono" id="hostname" style="font-size: 1.1rem">-</div>
      </div>
      <div>
        <div style="font-size: 0.8rem; color: var(--text-muted)">Local IP</div>
        <div
          class="mono"
          id="local-ip"
          style="color: var(--primary); font-size: 1.1rem"
        >
          -
        </div>
      </div>
    </div>
  </div>

  <!-- Resources -->
  <div class="bento-card span-2">
    <div class="card-header">
      <span class="card-title">Resources</span>
      <i class="ri-dashboard-line card-icon"></i>
    </div>
    <div style="display: flex; gap: 2rem">
      <div style="flex: 1">
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
          "
        >
          CPU Load
        </div>
        <div
          style="
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
          "
        >
          <div
            id="cpu-bar"
            style="
              height: 100%;
              width: 0%;
              background: var(--secondary);
              transition: width 0.5s;
            "
          ></div>
        </div>
        <div
          id="cpu-val"
          style="text-align: right; font-size: 0.8rem; margin-top: 0.25rem"
        >
          0%
        </div>
      </div>
      <div style="flex: 1">
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
          "
        >
          Memory
        </div>
        <div
          style="
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
          "
        >
          <div
            id="mem-bar"
            style="
              height: 100%;
              width: 0%;
              background: var(--primary);
              transition: width 0.5s;
            "
          ></div>
        </div>
        <div
          id="mem-val"
          style="text-align: right; font-size: 0.8rem; margin-top: 0.25rem"
        >
          0 MB
        </div>
      </div>
    </div>
  </div>

  <!-- Hotspot Control -->
  <div class="bento-card span-2">
    <div class="card-header">
      <span class="card-title">Hotspot Control</span>
      <i class="ri-wifi-line card-icon"></i>
    </div>
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid var(--glass-border);
      "
    >
      <div>
        <div style="font-weight: 600; color: var(--text-main)">
          Mobile Hotspot
        </div>
        <div style="font-size: 0.8rem; color: var(--text-muted)">
          SSID: NetVisor
        </div>
      </div>
      <label class="switch">
        <input
          type="checkbox"
          id="hotspot-toggle"
          onchange="toggleHotspot()"
          title="Toggle Hotspot"
        />
        <span class="slider round"></span>
      </label>
    </div>

    <!-- TShark Status REMOVED -->
    <div class="bento-card span-2" style="margin-top: 1rem; opacity: 0.5">
      <div class="card-header">
        <span class="card-title">Packet Capture Engine</span>
        <i class="ri-search-eye-line card-icon"></i>
      </div>
      <div
        style="
          padding: 0.5rem;
          text-align: center;
          color: var(--text-muted);
          font-size: 0.9rem;
        "
      >
        Engine Removed (Custom Build Pending)
      </div>
    </div>
    <p
      id="hotspot-msg"
      style="
        margin-top: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-muted);
        min-height: 1.2em;
      "
    ></p>
  </div>

  <!-- System Control -->
  <div class="bento-card span-1">
    <div class="card-header">
      <span class="card-title">System Control</span>
      <i class="ri-cpu-line card-icon"></i>
    </div>
    <div style="display: flex; flex-direction: column; gap: 1rem">
      <!-- Monitoring Toggle -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1rem;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 12px;
          border: 1px solid var(--glass-border);
        "
      >
        <div>
          <div style="font-weight: 600; color: var(--text-main)">
            Monitoring Engine
          </div>
          <div
            style="font-size: 0.8rem; color: var(--text-muted)"
            id="monitoring-status-text"
          >
            Pause/Resume
          </div>
        </div>
        <label class="switch">
          <input
            type="checkbox"
            id="monitoring-toggle"
            onchange="toggleMonitoring()"
            title="Toggle Monitoring"
          />
          <span class="slider round"></span>
        </label>
      </div>

      <!-- Maintenance Mode -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 1rem;
          background: rgba(255, 255, 255, 0.05);
          border-radius: 12px;
          border: 1px solid var(--glass-border);
        "
      >
        <div>
          <div style="font-weight: 600; color: var(--text-main)">
            Maintenance Mode
          </div>
          <div
            style="font-size: 0.8rem; color: var(--text-muted)"
            id="maintenance-status-text"
          >
            Public access restricted
          </div>
        </div>
        <label class="switch">
          <input
            type="checkbox"
            id="maintenance-toggle"
            onchange="toggleMaintenance()"
            title="Toggle Maintenance Mode"
          />
          <span class="slider round"></span>
        </label>
      </div>

      <!-- Force Scan Button -->
      <button
        class="action-btn"
        style="
          width: 100%;
          border-radius: 12px;
          gap: 0.5rem;
          justify-content: center;
        "
        onclick="triggerScan()"
      >
        <i class="ri-radar-line"></i> Force Network Scan
      </button>

      <!-- Admin Actions -->
      <div
        style="
          margin-top: 1rem;
          padding-top: 1rem;
          border-top: 1px solid var(--glass-border);
        "
      >
        <div
          style="
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
          "
        >
          Admin Controls
        </div>
        <button
          class="action-btn"
          style="
            width: 100%;
            border-radius: 12px;
            gap: 0.5rem;
            justify-content: center;
            margin-bottom: 0.5rem;
          "
          onclick="restartScanner()"
        >
          <i class="ri-restart-line"></i> Restart Scanner
        </button>

        <button
          class="action-btn danger-hover"
          style="
            width: 100%;
            border-radius: 12px;
            justify-content: center;
            border: 1px solid var(--danger);
            gap: 0.5rem;
          "
          onclick="resetDatabase()"
        >
          <i class="ri-delete-bin-2-line"></i> Reset Database
        </button>
      </div>
    </div>
  </div>

  <!-- Data Management -->
  <div class="bento-card span-1">
    <div class="card-header">
      <span class="card-title">Data Management</span>
      <i class="ri-database-2-line card-icon"></i>
    </div>
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: 100%;
        justify-content: center;
      "
    >
      <button
        class="action-btn danger-hover"
        style="
          width: 100%;
          padding: 1rem;
          border-radius: 12px;
          justify-content: center;
          border: 1px solid var(--danger);
        "
        onclick="resetData()"
      >
        <i class="ri-delete-bin-line"></i> Reset All Data
      </button>
      <div
        style="font-size: 0.8rem; color: var(--text-muted); text-align: center"
      >
        Clears all devices, logs, and alerts. Irreversible.
      </div>
    </div>
  </div>

  <!-- Appearance -->
  <div class="bento-card span-2">
    <div class="card-header">
      <span class="card-title">Appearance</span>
      <i class="ri-palette-line card-icon"></i>
    </div>
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 1rem;
        height: 100%;
        justify-content: center;
      "
    >
      <button
        class="action-btn"
        style="
          width: 100%;
          padding: 1rem;
          border-radius: 12px;
          justify-content: center;
        "
        onclick="toggleTheme()"
      >
        <i class="ri-sun-line" id="settings-theme-icon"></i>
        <span id="theme-text">Switch to Light Mode</span>
      </button>
    </div>
  </div>
</div>

<style>
  /* Switch Toggle */
  .switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #334155;
    transition: 0.4s;
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: var(--primary);
  }

  input:checked + .slider:before {
    transform: translateX(24px);
  }
</style>

{% endblock %} {% block scripts %}
<script>
  console.log("Settings page loaded");

  // --- Admin Stats ---
  async function loadAdminStats() {
    try {
      const res = await fetch("/api/admin/stats");
      const data = await res.json();

      const hostEl = document.getElementById("hostname");
      if (hostEl) hostEl.innerText = data.hostname;

      const ipEl = document.getElementById("local-ip");
      if (ipEl) ipEl.innerText = data.local_ip;

      const cpuVal = document.getElementById("cpu-val");
      if (cpuVal) cpuVal.innerText = data.cpu_percent + "%";

      const cpuBar = document.getElementById("cpu-bar");
      if (cpuBar) cpuBar.style.width = data.cpu_percent + "%";

      const memVal = document.getElementById("mem-val");
      if (memVal) {
        // Convert to GB for cleaner display
        const usedGB = (data.mem_used_mb / 1024).toFixed(1);
        const totalGB = (data.mem_total_mb / 1024).toFixed(1);
        memVal.innerText = `${usedGB} / ${totalGB} GB`;
      }

      const memBar = document.getElementById("mem-bar");
      if (memBar) {
        const memPercent = (data.mem_used_mb / data.mem_total_mb) * 100;
        memBar.style.width = memPercent + "%";
      }

      // Sync maintenance toggle if not currently being changed
      const mainToggle = document.getElementById("maintenance-toggle");
      const mainText = document.getElementById("maintenance-status-text");
      if (mainToggle && !mainToggle._isChanging) {
        mainToggle.checked = data.maintenance_mode;
        if (mainText)
          mainText.innerText = data.maintenance_mode
            ? "ACTIVE - Site Restricted"
            : "OFF - Site Public";
      }
    } catch (e) {
      console.error("Stats error:", e);
    }
  }

  // --- Hotspot Control ---
  async function checkHotspotStatus() {
    try {
      const res = await fetch("/api/admin/hotspot/status");
      const data = await res.json();
      const toggle = document.getElementById("hotspot-toggle");
      if (toggle) toggle.checked = data.active;
    } catch (e) {
      console.error("Hotspot status error:", e);
    }
  }

  async function toggleHotspot() {
    const toggle = document.getElementById("hotspot-toggle");
    const msg = document.getElementById("hotspot-msg");
    const action = toggle.checked ? "start" : "stop";

    msg.innerText = "Processing...";
    msg.style.color = "var(--text-muted)";

    try {
      const res = await fetch("/api/admin/hotspot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action }),
      });
      const data = await res.json();

      if (data.status === "success") {
        msg.innerText = data.message;
        msg.style.color = "var(--success)";
      } else {
        msg.innerText = "Error: " + data.message;
        msg.style.color = "var(--danger)";
        toggle.checked = !toggle.checked;
      }
    } catch (e) {
      msg.innerText = "Network Error";
      msg.style.color = "var(--danger)";
      toggle.checked = !toggle.checked;
    }
  }

  // --- System Control ---
  async function checkSystemStatus() {
    try {
      const res = await fetch("/api/settings/system/status");
      const data = await res.json();
      const toggle = document.getElementById("monitoring-toggle");
      const statusText = document.getElementById("monitoring-status-text");
      if (toggle) {
        toggle.checked = data.active;
        if (statusText)
          statusText.innerText = data.active
            ? "Active - Capturing Packets"
            : "Paused - No Capture";
      }
    } catch (e) {
      console.error("System status error:", e);
    }
  }

  async function toggleMonitoring() {
    const toggle = document.getElementById("monitoring-toggle");
    const statusText = document.getElementById("monitoring-status-text");
    const active = toggle.checked;

    if (statusText) statusText.innerText = "Updating...";

    try {
      await fetch("/api/settings/system", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ active }),
      });
      if (statusText)
        statusText.innerText = active
          ? "Active - Capturing Packets"
          : "Paused - No Capture";
    } catch (e) {
      alert("Error toggling monitoring");
      toggle.checked = !active;
      if (statusText) statusText.innerText = "Error";
    }
  }

  async function toggleMaintenance() {
    const toggle = document.getElementById("maintenance-toggle");
    const statusText = document.getElementById("maintenance-status-text");
    const active = toggle.checked;

    toggle._isChanging = true;
    if (statusText) statusText.innerText = "Updating...";

    try {
      const res = await fetch("/api/settings/maintenance", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ active }),
      });
      const data = await res.json();
      if (statusText)
        statusText.innerText = active
          ? "ACTIVE - Site Restricted"
          : "OFF - Site Public";
    } catch (e) {
      alert("Error toggling maintenance mode");
      toggle.checked = !active;
    } finally {
      toggle._isChanging = false;
    }
  }

  async function triggerScan() {
    const btn = document.querySelector('button[onclick="triggerScan()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="ri-loader-4-line ri-spin"></i> Scanning...';
    btn.disabled = true;

    try {
      const res = await fetch("/api/settings/refresh", { method: "POST" });
      const data = await res.json();
      btn.innerHTML = '<i class="ri-check-line"></i> Scan Complete';
      btn.style.borderColor = "var(--success)";
      btn.style.color = "var(--success)";
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        btn.style.borderColor = "";
        btn.style.color = "";
      }, 3000);
    } catch (e) {
      alert("Error triggering scan");
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  async function restartScanner() {
    if (
      !confirm(
        "Restart the background scanner service? Traffic monitoring will be briefly interrupted.",
      )
    )
      return;
    try {
      const res = await fetch("/api/admin/restart_scanner", { method: "POST" });
      const data = await res.json();
      alert(data.message);
    } catch (e) {
      alert("Error restarting scanner");
    }
  }

  async function resetDatabase() {
    if (
      !confirm(
        "CRITICAL WARNING: This will wipe ALL traffic logs, alerts, and device history. Users will remain. Are you sure?",
      )
    )
      return;
    try {
      const res = await fetch("/api/admin/reset_db", { method: "POST" });
      const data = await res.json();
      alert(data.message);
      window.location.reload();
    } catch (e) {
      alert("Error resetting database");
    }
  }

  // --- Data Management ---
  async function resetData() {
    if (
      !confirm(
        "Are you sure you want to delete ALL data? This cannot be undone.",
      )
    )
      return;
    try {
      const res = await fetch("/api/settings/reset", { method: "POST" });
      const data = await res.json();
      alert(data.message);
      window.location.reload();
    } catch (e) {
      alert("Error resetting data");
    }
  }

  // --- Theme (Using Global Layout Logic) ---
  // The global toggleTheme() in layout.html handles the logic.
  // We just need to update the button text/icon on this page to match the global state.

  function updateLocalThemeUI() {
    const root = document.documentElement;
    const isLight = root.getAttribute("data-theme") === "light";
    const settingsIcon = document.getElementById("settings-theme-icon");
    const text = document.getElementById("theme-text");

    if (isLight) {
      if (settingsIcon) settingsIcon.className = "ri-moon-line";
      if (text) text.innerText = "Switch to Dark Mode";
    } else {
      if (settingsIcon) settingsIcon.className = "ri-sun-line";
      if (text) text.innerText = "Switch to Light Mode";
    }
  }

  // Hook into the global toggle function by observing attribute changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (
        mutation.type === "attributes" &&
        mutation.attributeName === "data-theme"
      ) {
        updateLocalThemeUI();
        // Also ensure global icon updates if triggered from here
        const globalIcon = document.getElementById("theme-icon");
        if (globalIcon)
          globalIcon.className = isLight ? "ri-moon-line" : "ri-sun-line";
      }
    });
  });

  observer.observe(document.documentElement, {
    attributes: true, //configure it to listen to attribute changes
  });

  // Init
  document.addEventListener("DOMContentLoaded", () => {
    updateLocalThemeUI();

    loadAdminStats();
    checkHotspotStatus();
    checkSystemStatus();
    // checkTSharkStatus(); // REMOVED
    setInterval(loadAdminStats, 2000);
  });
</script>
{% endblock %}
